{% extends "base.html" %}

{% block content %}
<div class="w-full min-h-screen flex flex-col items-center justify-start py-10 bg-gray-50">

    <h1 class="text-3xl font-bold mb-2">Live Camera</h1>
    <p class="text-gray-600 text-center max-w-md mb-6">
        Izinkan akses kamera untuk memulai. Setelah kamera aktif, Anda bisa mengambil foto atau merekam video.
    </p>

    <!-- CAMERA FRAME -->
    <div class="w-full max-w-md bg-black rounded-xl shadow-lg overflow-hidden mb-6">
        <video id="cameraFeed" autoplay playsinline muted class="w-full h-auto"></video>
        <video id="remoteCamera" autoplay playsinline class="w-full h-auto hidden"></video>
    </div>

    <!-- WHITELIST MANAGER -->
    <div class="w-full max-w-4xl bg-white border border-gray-200 rounded-xl shadow-sm p-4 mb-8">
        <h2 class="text-xl font-semibold mb-3">Whitelist Manager</h2>

        <div class="grid md:grid-cols-2 gap-4">
            <!-- Upload -->
            <div>
                <label class="block mb-2 font-semibold text-gray-700">Upload Whitelist (Gambar)</label>
                <input id="whitelistInput" type="file" accept="image/*"
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm cursor-pointer
                              hover:border-blue-400 focus:ring-2 focus:ring-blue-500 transition">
                <p id="whitelistStatus" class="text-sm text-gray-600 mt-2"></p>
            </div>

            <!-- List -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-gray-700">Whitelist Files</span>
                    <button id="refreshWhitelistBtn"
                            class="text-sm px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-200">
                        Refresh
                    </button>
                </div>
                <div id="whitelistList"
                     class="grid sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-72 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                    <p class="text-gray-500 text-sm col-span-full">Memuat daftar whitelist...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROL BUTTONS -->
    <div class="flex flex-col space-y-3 w-full max-w-md">

        <!-- Start/Stop Camera -->
        <button id="startBtn"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl transition">
            Start Camera
        </button>

        <!-- Take Photo -->
        <!-- <button id="captureBtn" -->
        <!--         class="w-full bg-blue-500 text-white font-semibold py-3 rounded-xl transition opacity-40 cursor-not-allowed" -->
        <!--         disabled> -->
        <!--     Take Photo -->
        <!-- </button> -->

        <!-- Record Video -->
        <!-- <button id="recordBtn" -->
        <!--         class="w-full bg-purple-500 text-white font-semibold py-3 rounded-xl transition opacity-40 cursor-not-allowed" -->
        <!--         disabled> -->
        <!--     Start Recording -->
        <!-- </button> -->

    </div>

    <!-- SNAPSHOT RESULT -->
    <canvas id="snapshotCanvas"
            class="hidden mt-6 border rounded-xl shadow-lg max-w-md"></canvas>

    <!-- DOWNLOAD BUTTON -->
    <a id="downloadLink"
       class="hidden mt-4 bg-gray-800 text-white px-5 py-2 rounded-full shadow hover:bg-gray-900 transition"
       download>
        â¬‡ Download File
    </a>

</div>

<script>
    let stream = null;
    let mediaRecorder = null;
    let chunks = [];
    let recording = false;
    let pc = null;

    const video = document.getElementById("cameraFeed");
    const canvas = document.getElementById("snapshotCanvas");
    const downloadLink = document.getElementById("downloadLink");

    const startBtn = document.getElementById("startBtn");
    // const captureBtn = document.getElementById("captureBtn");
    // const recordBtn = document.getElementById("recordBtn");

    const whitelistInput = document.getElementById("whitelistInput");
    const whitelistStatus = document.getElementById("whitelistStatus");
    const whitelistList = document.getElementById("whitelistList");
    const refreshWhitelistBtn = document.getElementById("refreshWhitelistBtn");

    // ---------- Whitelist helpers ----------
    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function renderWhitelist(files) {
        whitelistList.innerHTML = "";
        if (!files || files.length === 0) {
            whitelistList.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Belum ada file whitelist.</p>';
            return;
        }

        files.forEach((f) => {
            const card = document.createElement("div");
            card.className = "bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col";

            const img = document.createElement("img");
            img.src = f.url;
            img.alt = f.name;
            img.className = "w-full h-28 object-cover bg-gray-100";

            const meta = document.createElement("div");
            meta.className = "px-3 py-2 flex items-center justify-between text-sm";
            meta.innerHTML = `
                <span class="truncate" title="${f.name}">${f.name}</span>
                <button class="text-red-500 hover:text-red-600" data-fname="${f.name}">ðŸ—‘</button>
            `;

            meta.querySelector("button").onclick = () => deleteWhitelist(f.name);

            card.appendChild(img);
            card.appendChild(meta);
            whitelistList.appendChild(card);
        });
    }

    async function fetchWhitelist() {
        whitelistList.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Memuat daftar whitelist...</p>';
        try {
            const res = await fetch("/be/list-whitelist");
            const data = await res.json();
            if (data.status === 1) {
                renderWhitelist(data.files);
            } else {
                whitelistList.innerHTML = `<p class="text-red-500 text-sm col-span-full">${data.message || "Gagal memuat daftar."}</p>`;
            }
        } catch (e) {
            whitelistList.innerHTML = `<p class="text-red-500 text-sm col-span-full">Error: ${e}</p>`;
        }
    }

    async function uploadWhitelistFile(file) {
        whitelistStatus.textContent = "Mengunggah...";
        whitelistStatus.className = "text-sm text-gray-600 mt-2";

        try {
            const base64 = await fileToBase64(file);
            const res = await fetch("/be/add-whitelist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: base64 })
            });
            const data = await res.json();
            if (data.status === 1) {
                whitelistStatus.textContent = "Upload berhasil!";
                whitelistStatus.classList.add("text-green-600");
                await fetchWhitelist();
            } else {
                whitelistStatus.textContent = data.message || "Upload gagal.";
                whitelistStatus.classList.add("text-red-500");
            }
        } catch (e) {
            whitelistStatus.textContent = `Error: ${e}`;
            whitelistStatus.classList.add("text-red-500");
        }
    }

    async function deleteWhitelist(filename) {
        const confirmDel = confirm(`Hapus file "${filename}"?`);
        if (!confirmDel) return;

        try {
            const res = await fetch("/be/del-whitelist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename })
            });
            const data = await res.json();
            if (data.status === 1) {
                await fetchWhitelist();
            } else {
                alert(data.message || "Gagal menghapus file.");
            }
        } catch (e) {
            alert("Error: " + e);
        }
    }

    // Handle whitelist image upload
    whitelistInput.addEventListener("change", async () => {
        if (whitelistInput.files.length > 0) {
            whitelistStatus.textContent = "Gambar whitelist dipilih: " + whitelistInput.files[0].name;
            whitelistStatus.classList.remove("text-red-500");
            whitelistStatus.classList.add("text-green-600");
            await uploadWhitelistFile(whitelistInput.files[0]); // auto-upload
            whitelistInput.value = "";
        } else {
            whitelistStatus.textContent = "Belum ada file dipilih.";
            whitelistStatus.classList.add("text-red-500");
        }
    });

    refreshWhitelistBtn.onclick = fetchWhitelist;

    // ---------- Camera controls ----------
    /*
    function enableControls() {
        captureBtn.disabled = false;
        recordBtn.disabled = false;
        captureBtn.classList.remove("opacity-40", "cursor-not-allowed");
        recordBtn.classList.remove("opacity-40", "cursor-not-allowed");
    }

    function disableControls() {
        captureBtn.disabled = true;
        recordBtn.disabled = true;
        captureBtn.classList.add("opacity-40", "cursor-not-allowed");
        recordBtn.classList.add("opacity-40", "cursor-not-allowed");
    }
    */

    // START CAMERA
async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video: true});
            video.srcObject = stream;

            pc = new RTCPeerConnection({iceServers: [
                { urls: ["stun:stun.l.google.com:19302"] },
                {
                    urls: [
                        "turn:openrelay.metered.ca:80",
                        "turn:openrelay.metered.ca:443",
                        "turn:openrelay.metered.ca:443?transport=tcp"
                    ],
                    username: "openrelayproject",
                    credential: "openrelayproject"
                }
            ]});

            stream.getTracks().forEach(track => pc.addTrack(track, stream));
            pc.ontrack = (event) => {
                const remote = document.getElementById("remoteCamera");
                if (remote) {
                    remote.srcObject = event.streams[0];
                    remote.classList.remove("hidden");
                }
            };
            pc.onconnectionstatechange = () => {
                console.log("STATE:", pc.connectionState);

                if (["disconnected", "failed", "closed"].includes(pc.connectionState)) {
                    pc.close();
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const response = await fetch('/offer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sdp: pc.localDescription.sdp,
                    type: pc.localDescription.type
                })
            });

            if (response.status === 401) {
                alert("Session expired. Please login again.");
                window.location.href = "/login";
                return;
            }

            const answer = await response.json();
            await pc.setRemoteDescription(answer);

            startBtn.textContent = "Stop Camera";
            startBtn.classList.remove("bg-green-500");
            startBtn.classList.add("bg-red-500");
        } catch (e) {
            alert("Tidak bisa membuka kamera: " + e);
        }
    }

    // STOP CAMERA
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        if (pc) {
            pc.getSenders().forEach(s => {
                try { if (s.track) s.track.stop(); } catch (_e) {}
            });
            pc.close();
            pc = null;
        }

        video.srcObject = null;

        startBtn.textContent = "Start Camera";
        startBtn.classList.remove("bg-red-500");
        startBtn.classList.add("bg-green-500");

        // disableControls();
    }

    // BUTTON EVENTS (TOGGLE CAMERA, TAKE PHOTO, RECORD VIDEO)
    startBtn.onclick = () => {
        if (!stream) startCamera();
        else stopCamera();
    };

    // TAKE PHOTO
  /*
    captureBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        canvas.classList.remove("hidden");

        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = "photo.png";
            downloadLink.textContent = "â¬‡ Download Photo";
            downloadLink.classList.remove("hidden");
        });
    };

    // RECORD VIDEO
    recordBtn.onclick = () => {
        if (!recording) {
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, {type: "video/webm"});
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = "video.webm";
                downloadLink.textContent = "â¬‡ Download Video";
                downloadLink.classList.remove("hidden");
            };

            mediaRecorder.start();
            recording = true;

            recordBtn.textContent = "Stop Recording";
            recordBtn.classList.remove("bg-purple-500");
            recordBtn.classList.add("bg-red-500");

        } else {
            mediaRecorder.stop();
            recording = false;

            recordBtn.textContent = "Start Recording";
            recordBtn.classList.remove("bg-red-500");
            recordBtn.classList.add("bg-purple-500");
        }
    };
    */

    // Initial load
    fetchWhitelist();
</script>

{% endblock %}
