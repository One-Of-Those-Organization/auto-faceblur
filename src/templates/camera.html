{% extends "base.html" %}

{% block content %}
<div class="w-full min-h-screen flex flex-col items-center justify-start py-10 bg-gray-50">

    <h1 class="text-3xl font-bold mb-2">Live Camera</h1>
    <p class="text-gray-600 text-center max-w-md mb-6">
        Izinkan akses kamera untuk memulai.  Setelah kamera aktif, Anda bisa mengambil foto atau merekam video.
    </p>

    <!-- CAMERA FRAME -->
    <div class="w-full max-w-md bg-black rounded-xl shadow-lg overflow-hidden mb-6">
        <video id="cameraFeed" autoplay playsinline muted class="w-full h-auto"></video>
        <canvas id="processedCanvas" class="w-full h-auto hidden"></canvas>
    </div>

    <!-- WHITELIST MANAGER -->
    <div class="w-full max-w-4xl bg-white border border-gray-200 rounded-xl shadow-sm p-4 mb-8">
        <h2 class="text-xl font-semibold mb-3">Whitelist Manager</h2>

        <div class="grid md:grid-cols-2 gap-4">
            <!-- Upload -->
            <div>
                <label class="block mb-2 font-semibold text-gray-700">Upload Whitelist (Gambar)</label>
                <input id="whitelistInput" type="file" accept="image/*"
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm cursor-pointer
                              hover:border-blue-400 focus:ring-2 focus:ring-blue-500 transition">
                <p id="whitelistStatus" class="text-sm text-gray-600 mt-2"></p>
            </div>

            <!-- List -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-gray-700">Whitelist Files</span>
                    <button id="refreshWhitelistBtn"
                            class="text-sm px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-200">
                        Refresh
                    </button>
                </div>
                <div id="whitelistList"
                     class="grid sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-72 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                    <p class="text-gray-500 text-sm col-span-full">Memuat daftar whitelist...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROL BUTTONS -->
    <div class="flex flex-col space-y-3 w-full max-w-md">

        <!-- Start/Stop Camera -->
        <button id="startBtn"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl transition">
            Start Camera
        </button>

    </div>

    <!-- SNAPSHOT RESULT -->
    <canvas id="snapshotCanvas"
            class="hidden mt-6 border rounded-xl shadow-lg max-w-md"></canvas>

    <!-- DOWNLOAD BUTTON -->
    <a id="downloadLink"
       class="hidden mt-4 bg-gray-800 text-white px-5 py-2 rounded-full shadow hover:bg-gray-900 transition"
       download>
        â¬‡ Download File
    </a>

    <!-- Connection Status -->
    <p id="connectionStatus" class="text-sm text-gray-500 mt-4"></p>

</div>

<script>
    let stream = null;
    let ws = null;
    let sendingFrames = false;
    let frameInterval = null;
    let authenticated = false;

    const MAX_FPS = 30;
    const FRAME_INTERVAL_MS = 1000 / MAX_FPS;

    const video = document.getElementById("cameraFeed");
    const processedCanvas = document.getElementById("processedCanvas");
    const snapshotCanvas = document.getElementById("snapshotCanvas");
    const downloadLink = document.getElementById("downloadLink");
    const connectionStatus = document.getElementById("connectionStatus");

    const startBtn = document.getElementById("startBtn");

    const whitelistInput = document.getElementById("whitelistInput");
    const whitelistStatus = document. getElementById("whitelistStatus");
    const whitelistList = document.getElementById("whitelistList");
    const refreshWhitelistBtn = document.getElementById("refreshWhitelistBtn");

    // ---------- Whitelist helpers ----------
    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function renderWhitelist(files) {
        whitelistList.innerHTML = "";
        if (! files || files.length === 0) {
            whitelistList.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Belum ada file whitelist. </p>';
            return;
        }

        files.forEach((f) => {
            const card = document.createElement("div");
            card.className = "bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col";

            const img = document.createElement("img");
            img.src = f.url;
            img.alt = f.name;
            img.className = "w-full h-28 object-cover bg-gray-100";

            const meta = document.createElement("div");
            meta.className = "px-3 py-2 flex items-center justify-between text-sm";
            meta.innerHTML = `
                <span class="truncate" title="${f.name}">${f.name}</span>
                <button class="text-red-500 hover:text-red-600" data-fname="${f.name}">ðŸ—‘</button>
            `;

            meta.querySelector("button").onclick = () => deleteWhitelist(f.name);

            card.appendChild(img);
            card.appendChild(meta);
            whitelistList.appendChild(card);
        });
    }

    async function fetchWhitelist() {
        whitelistList.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Memuat daftar whitelist...</p>';
        try {
            const res = await fetch("/be/list-whitelist");
            const data = await res.json();
            if (data.status === 1) {
                renderWhitelist(data.files);
            } else {
                whitelistList.innerHTML = `<p class="text-red-500 text-sm col-span-full">${data.message || "Gagal memuat daftar."}</p>`;
            }
        } catch (e) {
            whitelistList.innerHTML = `<p class="text-red-500 text-sm col-span-full">Error: ${e}</p>`;
        }
    }

    async function uploadWhitelistFile(file) {
        whitelistStatus.textContent = "Mengunggah... ";
        whitelistStatus. className = "text-sm text-gray-600 mt-2";

        try {
            const base64 = await fileToBase64(file);
            const res = await fetch("/be/add-whitelist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: base64 })
            });
            const data = await res.json();
            if (data.status === 1) {
                whitelistStatus.textContent = "Upload berhasil!";
                whitelistStatus.classList.add("text-green-600");
                await fetchWhitelist();
            } else {
                whitelistStatus.textContent = data.message || "Upload gagal.";
                whitelistStatus.classList.add("text-red-500");
            }
        } catch (e) {
            whitelistStatus.textContent = `Error: ${e}`;
            whitelistStatus.classList.add("text-red-500");
        }
    }

    async function deleteWhitelist(filename) {
        const confirmDel = confirm(`Hapus file "${filename}"?`);
        if (!confirmDel) return;

        try {
            const res = await fetch("/be/del-whitelist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename })
            });
            const data = await res.json();
            if (data.status === 1) {
                await fetchWhitelist();
            } else {
                alert(data. message || "Gagal menghapus file.");
            }
        } catch (e) {
            alert("Error: " + e);
        }
    }

    // Handle whitelist image upload
    whitelistInput. addEventListener("change", async () => {
        if (whitelistInput.files. length > 0) {
            whitelistStatus.textContent = "Gambar whitelist dipilih: " + whitelistInput.files[0].name;
            whitelistStatus.classList.remove("text-red-500");
            whitelistStatus.classList. add("text-green-600");
            await uploadWhitelistFile(whitelistInput.files[0]);
            whitelistInput.value = "";
        } else {
            whitelistStatus.textContent = "Belum ada file dipilih.";
            whitelistStatus.classList.add("text-red-500");
        }
    });

    refreshWhitelistBtn.onclick = fetchWhitelist;

    // ---------- WebSocket Camera Controls ----------

    function getWebSocketUrl() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        return `${protocol}//${window.location.host}/ws/camera`;
    }

    async function connectWebSocket() {
        return new Promise(async (resolve, reject) => {
            try {
                // Step 1: Get auth token from server
                connectionStatus.textContent = "Getting auth token...";
                connectionStatus.className = "text-sm text-gray-500 mt-4";

                const tokenRes = await fetch('/be/ws-token', { method: 'POST' });
                const tokenData = await tokenRes.json();

                if (tokenData.status !== 1) {
                    connectionStatus.textContent = "Failed to get token. Please login again.";
                    connectionStatus. className = "text-sm text-red-500 mt-4";
                    setTimeout(() => { window.location.href = "/login"; }, 2000);
                    reject(new Error("Failed to get WebSocket token"));
                    return;
                }

                // Step 2: Connect WebSocket
                connectionStatus.textContent = "Connecting... ";
                const wsUrl = getWebSocketUrl();
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log("WebSocket connected, sending auth token...");
                    connectionStatus.textContent = "Authenticating...";
                    // Send token as first message
                    ws.send(tokenData.token);
                };

                ws.onmessage = (event) => {
                    const data = event.data;

                    // Handle auth response
                    if (data === "auth:ok") {
                        console.log("WebSocket authenticated!");
                        authenticated = true;
                        connectionStatus.textContent = "Connected";
                        connectionStatus.className = "text-sm text-green-600 mt-4";
                        resolve();
                        return;
                    }

                    // Handle auth errors
                    if (data. startsWith("error:")) {
                        const errorType = data.split(":")[1];
                        console.error("WebSocket error:", errorType);
                        connectionStatus. textContent = "Auth failed: " + errorType;
                        connectionStatus. className = "text-sm text-red-500 mt-4";

                        if (errorType === "unauthorized" || errorType === "no_token") {
                            alert("Session expired. Please login again.");
                            window.location.href = "/login";
                        }
                        reject(new Error(errorType));
                        return;
                    }

                    // Handle processed frame (only after authenticated)
                    if (authenticated && data.startsWith("data:image")) {
                        const img = new Image();
                        img.onload = () => {
                            const ctx = processedCanvas.getContext("2d");
                            processedCanvas.width = img.width;
                            processedCanvas. height = img.height;
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = data;
                    }
                };

                ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    connectionStatus.textContent = "Connection error";
                    connectionStatus.className = "text-sm text-red-500 mt-4";
                    reject(error);
                };

                ws. onclose = () => {
                    console.log("WebSocket closed");
                    authenticated = false;
                    connectionStatus.textContent = "Disconnected";
                    connectionStatus.className = "text-sm text-gray-500 mt-4";
                    stopSendingFrames();
                };

            } catch (e) {
                connectionStatus.textContent = "Connection failed: " + e.message;
                connectionStatus.className = "text-sm text-red-500 mt-4";
                reject(e);
            }
        });
    }

    function startSendingFrames() {
        if (sendingFrames) return;
        sendingFrames = true;

        const tempCanvas = document.createElement("canvas");
        const tempCtx = tempCanvas.getContext("2d");

        frameInterval = setInterval(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN || !stream || !authenticated) {
                return;
            }

            if (video.videoWidth === 0 || video.videoHeight === 0) {
                return;
            }

            // Capture frame from video
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCtx.drawImage(video, 0, 0);

            // Convert to base64 JPEG
            const frameData = tempCanvas.toDataURL("image/jpeg", 0.8); // "data:image/jpeg;base64,..."

            // Attach timestamp so server can drop stale frames (UDP-style)
            const nowSec = Date.now() / 1000.0; // unix seconds
            const payload = `ts:${nowSec},${frameData}`;

            try {
                ws.send(payload);
            } catch (e) {
                console.error("Failed to send frame:", e);
            }
        }, FRAME_INTERVAL_MS);
    }

    function stopSendingFrames() {
        sendingFrames = false;
        if (frameInterval) {
            clearInterval(frameInterval);
            frameInterval = null;
        }
    }

    // START CAMERA
    async function startCamera() {
        try {
            // Get camera stream
            stream = await navigator. mediaDevices.getUserMedia({ video: true });
            video. srcObject = stream;

            // Wait for video to be ready
            await new Promise((resolve) => {
                video. onloadedmetadata = resolve;
            });

            // Connect WebSocket with token auth
            await connectWebSocket();

            // Show processed canvas
            processedCanvas.classList.remove("hidden");

            // Start sending frames
            startSendingFrames();

            startBtn.textContent = "Stop Camera";
            startBtn.classList.remove("bg-green-500");
            startBtn.classList.add("bg-red-500");
        } catch (e) {
            alert("Tidak bisa membuka kamera: " + e);
            console.error(e);
        }
    }

    // STOP CAMERA
    function stopCamera() {
        stopSendingFrames();

        if (ws) {
            ws. close();
            ws = null;
        }

        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }

        authenticated = false;
        video.srcObject = null;
        processedCanvas.classList.add("hidden");

        startBtn.textContent = "Start Camera";
        startBtn. classList.remove("bg-red-500");
        startBtn.classList.add("bg-green-500");

        connectionStatus.textContent = "";
    }

    // BUTTON EVENTS
    startBtn.onclick = () => {
        if (!stream) startCamera();
        else stopCamera();
    };

    // Initial load
    fetchWhitelist();
</script>

{% endblock %}
