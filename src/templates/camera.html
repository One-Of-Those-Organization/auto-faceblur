{% extends "base.html" %}

{% block content %}
<!-- TODO : INTEGRATE BACKEND PYTHON -->
<!-- WRAPPER FIX AGAR TIDAK KORUP BASE.HTML -->
<div class="w-full min-h-screen flex flex-col items-center justify-start py-10 bg-gray-50">

    <h1 class="text-3xl font-bold mb-2">Live Camera</h1>
    <p class="text-gray-600 text-center max-w-md mb-6">
        Izinkan akses kamera untuk memulai. Setelah kamera aktif, Anda bisa mengambil foto atau merekam video.
    </p>

    <!-- CAMERA FRAME -->
    <div class="w-full max-w-md bg-black rounded-xl shadow-lg overflow-hidden mb-6">
        <video id="cameraFeed" autoplay playsinline class="w-full h-auto"></video>
    </div>

    <!-- UPLOAD WHITELIST -->
    <div class="w-full max-w-md mb-6">
        <label class="block mb-2 font-semibold text-gray-700">Upload Whitelist (Gambar):</label>
        <input id="whitelistInput" type="file" accept="image/*"
               class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm cursor-pointer
                      hover:border-blue-400 focus:ring-2 focus:ring-blue-500 transition">
        <p id="whitelistStatus" class="text-sm text-gray-600 mt-2"></p>
    </div>

    <!-- CONTROL BUTTONS -->
    <div class="flex flex-col space-y-3 w-full max-w-md">

        <!-- Start/Stop Camera -->
        <button id="startBtn"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl transition">
            Start Camera
        </button>

        <!-- Take Photo -->
        <button id="captureBtn"
                class="w-full bg-blue-500 text-white font-semibold py-3 rounded-xl transition opacity-40 cursor-not-allowed"
                disabled>
            Take Photo
        </button>

        <!-- Record Video -->
        <button id="recordBtn"
                class="w-full bg-purple-500 text-white font-semibold py-3 rounded-xl transition opacity-40 cursor-not-allowed"
                disabled>
            Start Recording
        </button>

    </div>

    <!-- SNAPSHOT RESULT -->
    <canvas id="snapshotCanvas"
            class="hidden mt-6 border rounded-xl shadow-lg max-w-md"></canvas>

    <!-- DOWNLOAD BUTTON -->
    <a id="downloadLink"
       class="hidden mt-4 bg-gray-800 text-white px-5 py-2 rounded-full shadow hover:bg-gray-900 transition"
       download>
        ⬇ Download File
    </a>

</div>

<script>
    let stream = null;
    let mediaRecorder = null;
    let chunks = [];
    let recording = false;

    const video = document.getElementById("cameraFeed");
    const canvas = document.getElementById("snapshotCanvas");
    const downloadLink = document.getElementById("downloadLink");

    const startBtn = document.getElementById("startBtn");
    const captureBtn = document.getElementById("captureBtn");
    const recordBtn = document.getElementById("recordBtn");

    const whitelistInput = document.getElementById("whitelistInput");
    const whitelistStatus = document.getElementById("whitelistStatus");

    // Handle whitelist image upload
    whitelistInput.addEventListener("change", () => {
        if (whitelistInput.files.length > 0) {
            whitelistStatus.textContent = "Gambar whitelist dipilih: " + whitelistInput.files[0].name;
            whitelistStatus.classList.remove("text-red-500");
            whitelistStatus.classList.add("text-green-600");
        } else {
            whitelistStatus.textContent = "Belum ada file dipilih.";
            whitelistStatus.classList.add("text-red-500");
        }
    });

    // Toggle Enable Camera Controls
    function enableControls() {
        captureBtn.disabled = false;
        recordBtn.disabled = false;
        captureBtn.classList.remove("opacity-40", "cursor-not-allowed");
        recordBtn.classList.remove("opacity-40", "cursor-not-allowed");
    }

    // Disable Disable Camera Controls
    function disableControls() {
        captureBtn.disabled = true;
        recordBtn.disabled = true;
        captureBtn.classList.add("opacity-40", "cursor-not-allowed");
        recordBtn.classList.add("opacity-40", "cursor-not-allowed");
    }

    // START CAMERA
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video: true});
            video.srcObject = stream;

            startBtn.textContent = "Stop Camera";
            startBtn.classList.remove("bg-green-500");
            startBtn.classList.add("bg-red-500");

            enableControls();
        } catch (e) {
            alert("Tidak bisa membuka kamera: " + e);
        }
    }

    // STOP CAMERA
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }

        video.srcObject = null;

        startBtn.textContent = "Start Camera";
        startBtn.classList.remove("bg-red-500");
        startBtn.classList.add("bg-green-500");

        disableControls();
    }

    // BUTTON EVENTS (TOGGLE CAMERA, TAKE PHOTO, RECORD VIDEO)
    startBtn.onclick = () => {
        if (!stream) startCamera();
        else stopCamera();
    };

    // TAKE PHOTO
    captureBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        canvas.classList.remove("hidden");

        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = "photo.png";
            downloadLink.textContent = "⬇ Download Photo";
            downloadLink.classList.remove("hidden");
        });
    };

    // RECORD VIDEO
    recordBtn.onclick = () => {
        if (!recording) {
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, {type: "video/webm"});
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = "video.webm";
                downloadLink.textContent = "⬇ Download Video";
                downloadLink.classList.remove("hidden");
            };

            mediaRecorder.start();
            recording = true;

            recordBtn.textContent = "Stop Recording";
            recordBtn.classList.remove("bg-purple-500");
            recordBtn.classList.add("bg-red-500");

        } else {
            mediaRecorder.stop();
            recording = false;

            recordBtn.textContent = "Start Recording";
            recordBtn.classList.remove("bg-red-500");
            recordBtn.classList.add("bg-purple-500");
        }
    };
</script>

{% endblock %}